# 語言檢測邏輯說明

## 更新日期
2025-01-18

## 檢測優先順序

網站會按照以下優先順序自動選擇顯示語言：

### 1. 🍪 Cookie（最高優先）
- 如果使用者之前已經選擇過語言，會儲存在 cookie 中
- Cookie 名稱：`lang`
- 有效期：1 年
- 這確保使用者的語言偏好會被記住

### 2. 🔗 URL 參數
- URL 中包含 `?lang=pt`、`?lang=en` 或 `?lang=zh`
- 用於分享特定語言版本的連結
- 例如：`https://example.com/?lang=pt`

### 3. 🌐 子網域
- `cn.example.com` 或 `zh.example.com` → 中文
- 用於特定語言版本的網站

### 4. 📍 IP 地理位置（Cloudflare 提供）
透過 Cloudflare 的 `CF-IPCountry` header 自動檢測：

| 國家/地區 | 國家代碼 | 預設語言 |
|-----------|----------|----------|
| 🇧🇷 巴西 | BR | **葡萄牙語** |
| 🇵🇹 葡萄牙 | PT | **葡萄牙語** |
| 🇨🇳 中國 | CN | **中文** |
| 🇭🇰 香港 | HK | **中文** |
| 🇲🇴 澳門 | MO | **中文** |
| 🇹🇼 台灣 | TW | **中文** |
| 🌍 其他所有國家 | * | **英文** |

### 5. 🌏 瀏覽器語言設定（備用）
- 檢查 `Accept-Language` header
- 如果包含 `pt-BR` 或 `pt` → 葡萄牙語
- 如果包含 `zh` → 中文

### 6. 🇬🇧 預設語言
- 如果以上都無法判斷，預設顯示**英文**

## 重要說明

### ✅ 已實現功能
- **巴西 IP 自動顯示葡萄牙語**：所有來自巴西的訪客會自動看到葡萄牙語版本
- **其他國家預設英文**：除了特定國家外，其他所有國家都預設顯示英文
- **使用者可手動切換**：透過網站右上角的語言選擇器切換語言
- **記住使用者選擇**：一旦手動選擇語言，會覆蓋自動檢測

### 📌 技術細節
- 使用 Cloudflare Workers 環境
- `CF-IPCountry` header 由 Cloudflare 自動提供
- 不需要額外的 GeoIP 資料庫
- 語言切換立即生效，無需重新載入頁面

### 🔧 測試方法

#### 模擬不同國家訪問
1. **使用 VPN**：連接到巴西、中國或其他國家的 VPN
2. **修改 Header**：在開發環境可以手動設定 `CF-IPCountry` header
3. **URL 參數**：直接在 URL 加上 `?lang=pt` 測試

#### 清除語言設定
```javascript
// 在瀏覽器 Console 執行
document.cookie = 'lang=; Max-Age=0; Path=/';
location.reload();
```

## 使用案例

### 案例 1：巴西使用者首次訪問
1. 使用者從巴西訪問網站
2. Cloudflare 檢測到 IP 來自巴西（BR）
3. 網站自動顯示葡萄牙語版本
4. 使用者可以切換到其他語言

### 案例 2：美國使用者訪問
1. 使用者從美國訪問網站
2. Cloudflare 檢測到 IP 來自美國（US）
3. 網站自動顯示英文版本
4. 使用者可以切換到葡萄牙語或中文

### 案例 3：使用者分享連結
1. 巴西使用者分享連結給美國朋友
2. 可以加上 `?lang=pt` 確保朋友看到葡萄牙語版本
3. 例如：`https://example.com/casino/betano?lang=pt`

## 程式碼位置
- 檔案：`/src/utils/language.ts`
- 函數：`detectLanguage()`
- 行數：182-234